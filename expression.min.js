var DEFAULT_MINEURL="https://apps.araport.org/thalemine/",DEFAULT_ID="AT3G24650",DEFAULT_SVG="echart",DEFAULT_TYPE="Gene";"undefined"==typeof mineUrl&&(mineUrl=DEFAULT_MINEURL),"undefined"==typeof queryId&&(queryId=DEFAULT_ID),"undefined"==typeof svgId&&(svgId=DEFAULT_SVG),"undefined"==typeof type&&(type=DEFAULT_TYPE);var constraintOp="=",constraintPath="primaryIdentifier";"undefined"!=typeof listName&&(queryId=listName,constraintOp="IN",constraintPath=type),console.log(type+": "+svgId+" "+mineUrl+" "+queryId+" ("+constraintOp+" "+constraintPath+")");var query={from:type,select:["primaryIdentifier","symbol","RNASeqExpressions.expressionLevel","RNASeqExpressions.unit","RNASeqExpressions.experiment.SRAaccession","RNASeqExpressions.experiment.tissue"],orderBy:[{path:"primaryIdentifier",direction:"ASC"},{path:type+".RNASeqExpressions.experiment.tissue",direction:"ASC"},{path:type+".RNASeqExpressions.experiment.SRAaccession",direction:"ASC"}],where:[{path:constraintPath,op:constraintOp,value:queryId,code:"A"}]},GPORTAL="portal.do?class="+type+"&externalids=",EPORTAL="portal.do?class=RnaseqExperiment&externalids=",svg=d3.select("#"+svgId),color=null,barHeight=20,legendCells=8,halfBar=barHeight/2,cellWidth=halfBar,margin={left:4*barHeight,top:3*barHeight,right:3*barHeight,bottom:4*barHeight},width=parseInt(svg.style("width")),x=null,z=null,y=null,geneNr=null,tissueNr=null,sampleNr=null,xAxis=null,yAxis=null,linearLegend=null,legendLinear=null,render=function(){if(svg.attr("height",0),0!=data.length){var a=d3.max(data,function(a){return+a[2]}),b=d3.max(data,function(a){return Math.log2(a[2]+1)});geneNr=d3.map(data,function(a){return a[0]}).size(),tissueNr=d3.map(data,function(a){return a[5]}).size(),sampleNr=data.length/geneNr,xNr=d3.map(data,function(a){return a[4]}).size(),console.log("s:"+sampleNr+" t:"+tissueNr+" g:"+geneNr+" x:"+xNr+" Max:"+a+" log:"+b),1==geneNr&&(margin.left=barHeight,margin.right=2*barHeight,head=svg.append("foreignObject").attr("class","myheader").attr("x",0).attr("y",0).attr("width",width).attr("height",2*barHeight).append("xhtml:body").html('<h3 class="goog"> '+sampleNr+' Samples RNA Seq Expression - source: <a href="https://www.araport.org/">Araport</a></h3>             <p> <p>'));var c=d3.scale.linear().domain([0,b]).range(["palegreen","red"]);svg.attr("height",margin.top+barHeight*geneNr+margin.bottom+2*barHeight),cellWidth=(width-margin.right-margin.left-2*barHeight)/sampleNr,data.forEach(function(a){a.sra=+a[4],a.gene=+a[0],a.level=+a[2],a.tissue=+a[5]}),z=d3.scale.linear().range("white","blue"),z.domain([0,d3.max(data,function(a){return Math.log2(a[2]+1)})]),x=mineUrl.includes("thalemine")?d3.scale.ordinal().domain(d3.map(data,function(a){return a[5]}).keys()).range([0,7*cellWidth,9*cellWidth,16*cellWidth,40*cellWidth,85*cellWidth,87*cellWidth,96*cellWidth,103*cellWidth,106*cellWidth,110*cellWidth,sampleNr*cellWidth]):d3.scale.ordinal().domain(d3.map(data,function(a){return a[4]}).keys()).rangeBands([0,sampleNr*cellWidth]),y=d3.scale.ordinal().domain(d3.map(data,function(a){return a[0]}).keys()).rangeRoundBands([0,geneNr*barHeight]),xAxis=d3.svg.axis().scale(x).orient("bottom"),yAxis=d3.svg.axis().scale(y).orient("left"),svg.append("rect").attr("class","boundingbox").attr("x",0).attr("y",margin.top-barHeight).attr("height",margin.top+barHeight*geneNr+margin.bottom).attr("width",width-halfBar).style("stroke","grey").style("fill","none");var d=svg.selectAll("g").data(data);d.enter().append("g").attr("class","exbar").attr("transform",function(a,b){return"translate("+(margin.left+b%sampleNr*cellWidth)+","+(margin.top+barHeight*Math.floor(b/sampleNr))+")"}),d.append("a").on("mouseover",function(a,b){d3.select(this).attr({"xlink:href":mineUrl+EPORTAL+a[4]}).attr({"xlink:title":a[0]+"["+a[1]+"] - "+a[4]+" ("+a[5]+"): "+a[2]})}).append("rect").attr("width",cellWidth).attr("height",barHeight-1).style("fill",function(a){return c(Math.log2(a[2]+1))}),svg.append("g").attr("class","x axis").attr("transform",function(){return"translate( "+margin.left+","+(margin.top+geneNr*barHeight)+")"}).style("shape-rendering","crispEdges").call(xAxis).selectAll("text").attr("class","xticks").style("text-anchor","end").attr("dx","-.8em").attr("dy",".15em").attr("transform","rotate(-65)"),geneNr>1&&svg.append("g").attr("class","y axis").attr("transform",function(){return"translate("+margin.left+","+margin.right+")"}).call(d3.svg.axis().scale(y).orient("left")).call(yAxis).selectAll("text").filter(function(a){return"string"==typeof a}).style("cursor","pointer").on("click",function(a){document.location.href=mineUrl+GPORTAL+a}),linearLegend=d3.scale.linear().domain([0,a]).range(["palegreen","red"]),svg.append("g").attr("class","legendLinear").attr("transform","translate("+(margin.left+sampleNr*cellWidth+halfBar)+","+margin.top+")").style("font-size",halfBar+"px"),legendLinear=d3.legend.color().shapeWidth(halfBar).shapeHeight(halfBar).cells(legendCells).ascending("true").labelOffset(5).title("TPM").scale(linearLegend),svg.select(".legendLinear").call(legendLinear),svg.append("text").attr("class","note1").attr("x",margin.left+40*cellWidth).attr("y",barHeight*(geneNr+1)+2*margin.top).style("font-size",1.2*halfBar+"px").style("fill","gray").text("Levels expressed in Transcript Per Million (TPM)."),svg.append("text").attr("class","note2").attr("x",margin.left+40*cellWidth).attr("y",barHeight*(geneNr+2)+2*margin.top).style("font-size",1.2*halfBar+"px").style("fill","gray").text("The colouring is a log2 scale of TPM.")}},rescale=function(){var a=parseInt(svg.style("width"));cellWidth=(a-margin.right-margin.left-2*barHeight)/sampleNr,x.rangeBands([0,sampleNr*cellWidth]);var b=svg.selectAll(".exbar").data(data);b.attr("transform",function(a,b){return"translate("+(margin.left+b%sampleNr*cellWidth)+","+(margin.top+barHeight*Math.floor(b/sampleNr))+")"}),b.select("rect").attr("width",cellWidth).attr("height",barHeight-1);svg.select(".boundingbox").attr("width",a-halfBar);xAxis.scale(x),x.range([0,7*cellWidth,9*cellWidth,16*cellWidth,40*cellWidth,85*cellWidth,87*cellWidth,96*cellWidth,103*cellWidth,106*cellWidth,110*cellWidth,sampleNr*cellWidth]),svg.select(".x.axis").attr("transform",function(){return"translate( "+margin.left+","+(margin.top+geneNr*barHeight)+")"}).call(xAxis).selectAll("text").style("text-anchor","end").attr("dx","-.8em").attr("dy",".15em").attr("transform","rotate(-65)").filter(function(a){return"string"==typeof a}).style("cursor","pointer").on("click",function(a){document.location.href=mineUrl+EPORTAL+a}),svg.select(".legendLinear").attr("transform","translate("+(margin.left+sampleNr*cellWidth+halfBar)+","+margin.top+")").call(d3.legend.color().shapeWidth(halfBar).shapeHeight(halfBar).cells(legendCells).ascending("true").labelOffset(5).title("TPM").scale(linearLegend)),head=svg.select(".myheader").attr("width",a),svg.select(".note1").attr("x",margin.left+40*cellWidth),svg.select(".note2").attr("x",margin.left+40*cellWidth)},myService=null;myService="undefined"==typeof token||null===token?new imjs.Service({root:mineUrl+"service/"}):new imjs.Service({root:mineUrl,token:token}),myService.rows(query).then(function(a){data=a,render()}),d3.select(window).on("resize",rescale);